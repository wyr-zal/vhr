# VHR 项目业务流程图总览

本文档汇总微人事（VHR）项目的所有核心业务流程图。

---

## 目录

1. [系统整体架构](#1-系统整体架构)
2. [用户认证流程](#2-用户认证流程)
3. [权限校验流程](#3-权限校验流程)
4. [动态菜单加载流程](#4-动态菜单加载流程)
5. [员工管理流程](#5-员工管理流程)
6. [邮件发送流程](#6-邮件发送流程)
7. [在线聊天流程](#7-在线聊天流程)
8. [数据流转总图](#8-数据流转总图)

---

## 1. 系统整体架构

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                   VHR 系统架构                                       │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                              前端 (Vue 2 + Element UI)                       │  │
│   │                                   端口: 8080                                 │  │
│   │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐      │  │
│   │  │  登录页  │  │  首页    │  │ 员工管理 │  │ 薪资管理 │  │ 在线聊天 │      │  │
│   │  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘  └────┬─────┘      │  │
│   │       │             │             │             │             │             │  │
│   │       └─────────────┴─────────────┴─────────────┴─────────────┘             │  │
│   │                                   │                                          │  │
│   │                          Axios / WebSocket                                   │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                             │
│                                       ▼                                             │
│   ┌─────────────────────────────────────────────────────────────────────────────┐  │
│   │                         后端 vhr-web (Spring Boot)                           │  │
│   │                                   端口: 8081                                 │  │
│   │                                                                             │  │
│   │  ┌─────────────────────────────────────────────────────────────────────┐   │  │
│   │  │                      Spring Security 过滤器链                        │   │  │
│   │  │  ┌──────────┐  ┌──────────────┐  ┌─────────────────┐  ┌──────────┐  │   │  │
│   │  │  │LoginFilter│→│MetadataSource│→│DecisionManager  │→│Controller│  │   │  │
│   │  │  └──────────┘  └──────────────┘  └─────────────────┘  └──────────┘  │   │  │
│   │  └─────────────────────────────────────────────────────────────────────┘   │  │
│   │                                     │                                       │  │
│   │  ┌──────────────────────────────────┴───────────────────────────────────┐  │  │
│   │  │                          Service 层                                   │  │  │
│   │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐  │  │  │
│   │  │  │HrService │  │MenuService│ │EmployeeService│ │其他Service...    │  │  │  │
│   │  │  └──────────┘  └──────────┘  └──────────┘  └──────────────────────┘  │  │  │
│   │  └──────────────────────────────────────────────────────────────────────┘  │  │
│   │                                     │                                       │  │
│   │  ┌──────────────────────────────────┴───────────────────────────────────┐  │  │
│   │  │                          Mapper 层 (MyBatis)                          │  │  │
│   │  └──────────────────────────────────────────────────────────────────────┘  │  │
│   └─────────────────────────────────────────────────────────────────────────────┘  │
│                                       │                                             │
│         ┌─────────────────────────────┼─────────────────────────────┐              │
│         ▼                             ▼                             ▼              │
│   ┌──────────┐                 ┌──────────┐                 ┌──────────────┐       │
│   │  MySQL   │                 │  Redis   │                 │  RabbitMQ    │       │
│   │ 数据存储  │                 │ 菜单缓存  │                 │  消息队列    │       │
│   │          │                 │ 邮件去重  │                 │              │       │
│   └──────────┘                 └──────────┘                 └──────┬───────┘       │
│                                                                    │               │
│                                                                    ▼               │
│                                                          ┌──────────────────┐      │
│                                                          │   mailserver     │      │
│                                                          │   邮件微服务      │      │
│                                                          │   端口: 8082     │      │
│                                                          └────────┬─────────┘      │
│                                                                   │                │
│                                                                   ▼                │
│                                                          ┌──────────────────┐      │
│                                                          │   SMTP 邮件服务   │      │
│                                                          │   (QQ邮箱等)     │      │
│                                                          └──────────────────┘      │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. 用户认证流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                                用户登录认证流程                                      │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────┐                                                                        │
│  │  用户   │                                                                        │
│  └────┬────┘                                                                        │
│       │                                                                             │
│       │ 1. GET /verifyCode                                                          │
│       ▼                                                                             │
│  ┌─────────────────┐                                                               │
│  │ 获取验证码图片   │ ──────────────────────────────────────────┐                   │
│  └────────┬────────┘                                           │                   │
│           │                                                    ▼                   │
│           │                                          ┌──────────────────┐          │
│           │                                          │ Session 存储     │          │
│           │                                          │ verify_code=ABCD │          │
│           │                                          └──────────────────┘          │
│           ▼                                                    │                   │
│  ┌─────────────────┐                                           │                   │
│  │ 显示验证码图片   │                                           │                   │
│  └────────┬────────┘                                           │                   │
│           │                                                    │                   │
│           │ 2. POST /doLogin                                   │                   │
│           │    {username, password, code}                      │                   │
│           ▼                                                    │                   │
│  ┌─────────────────────────────────────────────────────────────┴───────────────┐   │
│  │                           LoginFilter                                        │   │
│  ├──────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                              │   │
│  │  ┌────────────────┐     ┌────────────────┐     ┌────────────────┐           │   │
│  │  │ 解析JSON请求体  │ ──▶ │ 校验验证码     │ ──▶ │ 构建认证令牌   │           │   │
│  │  │ username       │     │ code vs session│     │ UsernamePassword│           │   │
│  │  │ password       │     │                │     │ AuthToken       │           │   │
│  │  │ code           │     │                │     │                 │           │   │
│  │  └────────────────┘     └───────┬────────┘     └────────┬────────┘           │   │
│  │                                 │                       │                    │   │
│  │                          验证码错误                      │                    │   │
│  │                                 │                       │                    │   │
│  │                                 ▼                       ▼                    │   │
│  │                    ┌──────────────────┐    ┌─────────────────────────────┐   │   │
│  │                    │ 返回错误:        │    │ AuthenticationManager       │   │   │
│  │                    │ "验证码不正确"   │    │ .authenticate()             │   │   │
│  │                    └──────────────────┘    └──────────────┬──────────────┘   │   │
│  │                                                           │                  │   │
│  └───────────────────────────────────────────────────────────┼──────────────────┘   │
│                                                              │                      │
│                                                              ▼                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                           HrService.loadUserByUsername()                       │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │  ┌────────────────────┐      ┌────────────────────┐      ┌────────────────┐  │  │
│  │  │ 查询用户基础信息    │ ──▶  │ 查询用户角色列表   │ ──▶  │ 返回Hr对象     │  │  │
│  │  │ hrMapper.          │      │ hrMapper.          │      │ (含roles)     │  │  │
│  │  │ loadUserByUsername │      │ getHrRolesById     │      │               │  │  │
│  │  └────────────────────┘      └────────────────────┘      └───────┬────────┘  │  │
│  │                                                                  │           │  │
│  └──────────────────────────────────────────────────────────────────┼───────────┘  │
│                                                                     │              │
│                                                                     ▼              │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                      BCryptPasswordEncoder.matches()                           │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │               输入密码 ────────────────▶ 与数据库密文比对                      │  │
│  │                                              │                                │  │
│  │                              ┌───────────────┴───────────────┐                │  │
│  │                              ▼                               ▼                │  │
│  │                      ┌──────────────┐                ┌──────────────┐         │  │
│  │                      │   匹配成功   │                │   匹配失败   │         │  │
│  │                      └──────┬───────┘                └──────┬───────┘         │  │
│  │                             │                               │                 │  │
│  └─────────────────────────────┼───────────────────────────────┼─────────────────┘  │
│                                │                               │                    │
│                                ▼                               ▼                    │
│  ┌───────────────────────────────────────┐    ┌───────────────────────────────┐    │
│  │          认证成功处理                  │    │        认证失败处理            │    │
│  ├───────────────────────────────────────┤    ├───────────────────────────────┤    │
│  │                                       │    │                               │    │
│  │  1. 清空密码字段                      │    │  根据异常类型返回提示:         │    │
│  │  2. 构建成功响应                      │    │  - LockedException            │    │
│  │     {                                 │    │    → "账户被锁定"              │    │
│  │       status: 200,                    │    │  - BadCredentialsException    │    │
│  │       msg: "登录成功!",               │    │    → "用户名或密码错误"        │    │
│  │       obj: {用户信息}                 │    │  - DisabledException          │    │
│  │     }                                 │    │    → "账户被禁用"              │    │
│  │  3. 注册会话到SessionRegistry         │    │                               │    │
│  │                                       │    │                               │    │
│  └───────────────────────────────────────┘    └───────────────────────────────┘    │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 权限校验流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              URL 权限校验流程                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────┐                                                                        │
│  │  用户   │                                                                        │
│  └────┬────┘                                                                        │
│       │                                                                             │
│       │  HTTP 请求: GET /employee/basic/                                            │
│       ▼                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      FilterSecurityInterceptor                               │   │
│  │                      (Spring Security 核心拦截器)                            │   │
│  └────────────────────────────────────┬────────────────────────────────────────┘   │
│                                       │                                             │
│                                       ▼                                             │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │              CustomFilterInvocationSecurityMetadataSource                    │   │
│  │                          (获取URL所需权限)                                   │   │
│  ├─────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                             │   │
│  │  1. 获取请求URL: /employee/basic/                                           │   │
│  │                          │                                                  │   │
│  │                          ▼                                                  │   │
│  │  2. 查询所有菜单及角色关系 (从Redis缓存)                                     │   │
│  │     menuService.getAllMenusWithRole()                                       │   │
│  │                          │                                                  │   │
│  │                          ▼                                                  │   │
│  │     ┌────────────────────────────────────────────────────────────────┐     │   │
│  │     │  菜单列表:                                                      │     │   │
│  │     │  ┌──────────────────────────────────────────────────────────┐  │     │   │
│  │     │  │ URL: /employee/**  │ Roles: [ROLE_ADMIN, ROLE_PERSONNEL] │  │     │   │
│  │     │  ├──────────────────────────────────────────────────────────┤  │     │   │
│  │     │  │ URL: /salary/**    │ Roles: [ROLE_ADMIN, ROLE_FINANCE]   │  │     │   │
│  │     │  ├──────────────────────────────────────────────────────────┤  │     │   │
│  │     │  │ URL: /system/**    │ Roles: [ROLE_ADMIN]                 │  │     │   │
│  │     │  └──────────────────────────────────────────────────────────┘  │     │   │
│  │     └────────────────────────────────────────────────────────────────┘     │   │
│  │                          │                                                  │   │
│  │                          ▼                                                  │   │
│  │  3. AntPathMatcher 匹配                                                     │   │
│  │     /employee/** ←匹配→ /employee/basic/  ✓                                 │   │
│  │                          │                                                  │   │
│  │                          ▼                                                  │   │
│  │  4. 返回所需权限: [ROLE_ADMIN, ROLE_PERSONNEL]                              │   │
│  │     (若无匹配返回 ROLE_LOGIN)                                               │   │
│  │                                                                             │   │
│  └──────────────────────────────────────────┬──────────────────────────────────┘   │
│                                             │                                       │
│                                             ▼                                       │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                      CustomUrlDecisionManager                                │   │
│  │                          (权限决策)                                          │   │
│  ├─────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                             │   │
│  │  所需权限: [ROLE_ADMIN, ROLE_PERSONNEL]                                     │   │
│  │  用户权限: [ROLE_PERSONNEL]  (从Authentication获取)                         │   │
│  │                                                                             │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │                        决策逻辑                                      │   │   │
│  │  ├─────────────────────────────────────────────────────────────────────┤   │   │
│  │  │                                                                     │   │   │
│  │  │  for (所需权限) {                                                   │   │   │
│  │  │      if (权限 == "ROLE_LOGIN") {                                   │   │   │
│  │  │          if (用户是匿名用户) throw "尚未登录";                       │   │   │
│  │  │          else return; // 已登录即可                                 │   │   │
│  │  │      }                                                              │   │   │
│  │  │      if (用户拥有该权限) return; // 放行                            │   │   │
│  │  │  }                                                                  │   │   │
│  │  │  throw "权限不足";                                                  │   │   │
│  │  │                                                                     │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                             │   │
│  │  决策结果:                                                                  │   │
│  │  ┌─────────────────────────────────────────────────────────────────────┐   │   │
│  │  │  ROLE_ADMIN ←→ [ROLE_PERSONNEL]  ✗ 不匹配                          │   │   │
│  │  │  ROLE_PERSONNEL ←→ [ROLE_PERSONNEL]  ✓ 匹配! → 放行                 │   │   │
│  │  └─────────────────────────────────────────────────────────────────────┘   │   │
│  │                                                                             │   │
│  └──────────────────────────────────────────┬──────────────────────────────────┘   │
│                                             │                                       │
│                         ┌───────────────────┴───────────────────┐                  │
│                         ▼                                       ▼                  │
│              ┌────────────────────┐                  ┌────────────────────┐        │
│              │      放行          │                  │      拒绝          │        │
│              │   请求到达Controller│                  │   返回403/401     │        │
│              └────────────────────┘                  └────────────────────┘        │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. 动态菜单加载流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              动态菜单加载流程                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                              前端 (Vue)                                        │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │  ┌─────────────┐       ┌─────────────────────────────────────────────────┐   │  │
│  │  │ 用户登录成功 │ ──▶   │ sessionStorage.setItem("user", JSON.stringify()) │   │  │
│  │  └─────────────┘       └────────────────────────┬────────────────────────┘   │  │
│  │                                                 │                            │  │
│  │                                                 ▼                            │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                    main.js 路由前置守卫                                  │ │  │
│  │  │  router.beforeEach((to, from, next) => {                                │ │  │
│  │  │      if (sessionStorage.getItem("user")) {                              │ │  │
│  │  │          initMenu(router, store);  // 初始化菜单                        │ │  │
│  │  │      }                                                                  │ │  │
│  │  │  })                                                                     │ │  │
│  │  └─────────────────────────────────────┬───────────────────────────────────┘ │  │
│  │                                        │                                      │  │
│  │                                        ▼                                      │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                      menus.js - initMenu()                               │ │  │
│  │  ├─────────────────────────────────────────────────────────────────────────┤ │  │
│  │  │                                                                         │ │  │
│  │  │  1. 检查 store.state.routes 是否已加载                                  │ │  │
│  │  │     if (store.state.routes.length > 0) return;                          │ │  │
│  │  │                        │                                                │ │  │
│  │  │                        ▼                                                │ │  │
│  │  │  2. 发起请求: GET /system/config/menu ──────────────────────────┐       │ │  │
│  │  │                        │                                        │       │ │  │
│  │  └────────────────────────┼────────────────────────────────────────┼───────┘ │  │
│  │                           │                                        │         │  │
│  └───────────────────────────┼────────────────────────────────────────┼─────────┘  │
│                              │                                        │            │
│                              │                                        ▼            │
│  ┌───────────────────────────┼──────────────────────────────────────────────────┐  │
│  │                           │            后端处理                               │  │
│  ├───────────────────────────┼──────────────────────────────────────────────────┤  │
│  │                           │                                                  │  │
│  │                           │   ┌────────────────────────────────────────────┐ │  │
│  │                           │   │          SystemConfigController            │ │  │
│  │                           │   │  @GetMapping("/system/config/menu")        │ │  │
│  │                           │   │  return menuService.getMenusByHrId();      │ │  │
│  │                           │   └───────────────────┬────────────────────────┘ │  │
│  │                           │                       │                          │  │
│  │                           │                       ▼                          │  │
│  │                           │   ┌────────────────────────────────────────────┐ │  │
│  │                           │   │              MenuService                   │ │  │
│  │                           │   │  1. 从SecurityContext获取当前用户ID        │ │  │
│  │                           │   │  2. 查询该用户有权限的菜单树               │ │  │
│  │                           │   │     (user → roles → menu_role → menu)      │ │  │
│  │                           │   └───────────────────┬────────────────────────┘ │  │
│  │                           │                       │                          │  │
│  │                           │                       ▼                          │  │
│  │                           │   ┌────────────────────────────────────────────┐ │  │
│  │                           │   │              返回菜单树                     │ │  │
│  │                           │   │  [                                         │ │  │
│  │                           │   │    {                                       │ │  │
│  │                           │   │      name: "员工管理",                     │ │  │
│  │                           │   │      path: "/emp",                         │ │  │
│  │                           │   │      component: "Home",                    │ │  │
│  │                           │   │      children: [                           │ │  │
│  │                           │   │        { name:"基本资料", path:"/basic" }  │ │  │
│  │                           │   │      ]                                     │ │  │
│  │                           │   │    }                                       │ │  │
│  │                           │   │  ]                                         │ │  │
│  │                           │   └───────────────────┬────────────────────────┘ │  │
│  │                           │                       │                          │  │
│  └───────────────────────────┼───────────────────────┼──────────────────────────┘  │
│                              │                       │                             │
│                              │◀──────────────────────┘                             │
│                              ▼                                                      │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                          前端菜单处理                                          │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  3. formatRoutes(menus) - 转换为Vue Router格式                          │ │  │
│  │  │     - 根据 component 字段动态加载 .vue 文件                              │ │  │
│  │  │     - require('@/views/' + component)                                   │ │  │
│  │  └───────────────────────────────────────┬─────────────────────────────────┘ │  │
│  │                                          │                                    │  │
│  │                                          ▼                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  4. router.addRoutes(routes) - 动态添加路由                              │ │  │
│  │  └───────────────────────────────────────┬─────────────────────────────────┘ │  │
│  │                                          │                                    │  │
│  │                                          ▼                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  5. store.commit('initRoutes', routes) - 保存到Vuex                      │ │  │
│  │  └───────────────────────────────────────┬─────────────────────────────────┘ │  │
│  │                                          │                                    │  │
│  │                                          ▼                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  6. Home.vue 读取 $store.state.routes 渲染侧边栏菜单                     │ │  │
│  │  │     <el-menu>                                                           │ │  │
│  │  │       <el-submenu v-for="route in routes">                              │ │  │
│  │  │         <el-menu-item v-for="child in route.children">                  │ │  │
│  │  │       </el-submenu>                                                     │ │  │
│  │  │     </el-menu>                                                          │ │  │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 员工管理流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              员工管理业务流程                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              新增员工流程                                    │   │
│  ├─────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                             │   │
│  │  前端 ──POST /emp/basic──▶ EmpBasicController ──▶ EmployeeService.addEmp()  │   │
│  │                                                          │                  │   │
│  │                                          ┌───────────────┴───────────────┐  │   │
│  │                                          ▼                               ▼  │   │
│  │                              ┌─────────────────────┐    ┌──────────────────┐│   │
│  │                              │ 1. 计算合同年限     │    │ 2. 插入数据库    ││   │
│  │                              │    (结束-开始)/12   │    │    employee表    ││   │
│  │                              └─────────────────────┘    └────────┬─────────┘│   │
│  │                                                                  │          │   │
│  │                                                     插入成功      │          │   │
│  │                                                                  ▼          │   │
│  │                                                    ┌──────────────────────┐ │   │
│  │                                                    │ 3. 发送MQ消息       │ │   │
│  │                                                    │    触发邮件通知     │ │   │
│  │                                                    └──────────────────────┘ │   │
│  │                                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              分页查询流程                                    │   │
│  ├─────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                             │   │
│  │  前端 ──GET /emp/basic?page=1&size=10──▶ Controller ──▶ Service             │   │
│  │                                                           │                 │   │
│  │                                                           ▼                 │   │
│  │                                      ┌─────────────────────────────────────┐│   │
│  │                                      │ EmployeeService.getEmployeeByPage() ││   │
│  │                                      │                                     ││   │
│  │                                      │ 1. 分页参数转换: page=(page-1)*size ││   │
│  │                                      │ 2. 查询数据列表: employeeMapper     ││   │
│  │                                      │ 3. 查询总数: getTotal()             ││   │
│  │                                      │ 4. 封装RespPageBean返回             ││   │
│  │                                      └─────────────────────────────────────┘│   │
│  │                                                                             │   │
│  │  支持的筛选条件:                                                             │   │
│  │  ┌───────────┬───────────┬───────────┬───────────┬───────────────────────┐  │   │
│  │  │ 姓名(模糊) │ 政治面貌  │   民族    │   职位    │ 入职日期范围          │  │   │
│  │  └───────────┴───────────┴───────────┴───────────┴───────────────────────┘  │   │
│  │                                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                              Excel导入/导出流程                              │   │
│  ├─────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                             │   │
│  │  导出:                                                                      │   │
│  │  GET /emp/basic/export ──▶ Controller ──▶ POI生成Excel ──▶ 返回文件流       │   │
│  │                                                                             │   │
│  │  导入:                                                                      │   │
│  │  POST /emp/basic/import ──▶ MultipartFile ──▶ POI解析 ──▶ 批量插入数据库    │   │
│  │                                                                             │   │
│  └─────────────────────────────────────────────────────────────────────────────┘   │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 6. 邮件发送流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              邮件发送完整流程                                        │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌─────────────────────────────────────────────────────────────────────────────┐   │
│  │                     vhr-service (生产者)                                     │   │
│  ├─────────────────────────────────────────────────────────────────────────────┤   │
│  │                                                                             │   │
│  │  EmployeeService.addEmp()                                                   │   │
│  │         │                                                                   │   │
│  │         ▼                                                                   │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  1. 员工数据插入成功                                                  │  │   │
│  │  └──────────────────────────────────────────────────────────────────────┘  │   │
│  │         │                                                                   │   │
│  │         ▼                                                                   │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  2. 生成消息ID: UUID.randomUUID()                                     │  │   │
│  │  └──────────────────────────────────────────────────────────────────────┘  │   │
│  │         │                                                                   │   │
│  │         ▼                                                                   │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  3. 记录发送日志到数据库                                              │  │   │
│  │  │     INSERT INTO mail_send_log                                        │  │   │
│  │  │     (msgId, empId, status=0, createTime, tryTime)                    │  │   │
│  │  └──────────────────────────────────────────────────────────────────────┘  │   │
│  │         │                                                                   │   │
│  │         ▼                                                                   │   │
│  │  ┌──────────────────────────────────────────────────────────────────────┐  │   │
│  │  │  4. 发送消息到RabbitMQ                                                │  │   │
│  │  │     rabbitTemplate.convertAndSend(                                   │  │   │
│  │  │         exchange: "javaboy.mail.exchange",                           │  │   │
│  │  │         routingKey: "javaboy.mail.routing.key",                      │  │   │
│  │  │         message: Employee对象,                                       │  │   │
│  │  │         correlationData: msgId                                       │  │   │
│  │  │     )                                                                │  │   │
│  │  └────────────────────────────────┬─────────────────────────────────────┘  │   │
│  │                                   │                                        │   │
│  └───────────────────────────────────┼────────────────────────────────────────┘   │
│                                      │                                             │
│                                      ▼                                             │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                              RabbitMQ                                          │ │
│  ├───────────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                               │ │
│  │    ┌───────────────────┐         ┌───────────────────┐                       │ │
│  │    │ Direct Exchange   │ ──────▶ │     Queue         │                       │ │
│  │    │ javaboy.mail.     │  bind   │ javaboy.mail.     │                       │ │
│  │    │ exchange          │ ──────▶ │ queue             │                       │ │
│  │    └───────────────────┘         └─────────┬─────────┘                       │ │
│  │                                            │                                  │ │
│  └────────────────────────────────────────────┼──────────────────────────────────┘ │
│                                               │                                    │
│                                               │ 消费                               │
│                                               ▼                                    │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                     mailserver (消费者)                                        │ │
│  ├───────────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                               │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  MailReceiver.handler()                                                 │ │ │
│  │  │  @RabbitListener(queues = "javaboy.mail.queue")                         │ │ │
│  │  └────────────────────────────────┬────────────────────────────────────────┘ │ │
│  │                                   │                                          │ │
│  │                                   ▼                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  1. 解析消息                                                            │ │ │
│  │  │     Employee employee = message.getPayload()                            │ │ │
│  │  │     String msgId = headers.get("correlation")                           │ │ │
│  │  └────────────────────────────────┬────────────────────────────────────────┘ │ │
│  │                                   │                                          │ │
│  │                                   ▼                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  2. Redis幂等检查                                                       │ │ │
│  │  │     if (redis.hash("mail_log").contains(msgId)) {                       │ │ │
│  │  │         channel.basicAck();  // 已处理，直接确认                        │ │ │
│  │  │         return;                                                         │ │ │
│  │  │     }                                                                   │ │ │
│  │  └────────────────────────────────┬────────────────────────────────────────┘ │ │
│  │                                   │                                          │ │
│  │                                   ▼                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  3. Thymeleaf渲染邮件模板                                               │ │ │
│  │  │     Context context = new Context();                                    │ │ │
│  │  │     context.setVariable("name", employee.getName());                    │ │ │
│  │  │     context.setVariable("posName", ...);                                │ │ │
│  │  │     String content = templateEngine.process("mail", context);           │ │ │
│  │  └────────────────────────────────┬────────────────────────────────────────┘ │ │
│  │                                   │                                          │ │
│  │                                   ▼                                          │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  4. 发送邮件                                                            │ │ │
│  │  │     MimeMessage msg = javaMailSender.createMimeMessage();               │ │ │
│  │  │     helper.setTo(employee.getEmail());                                  │ │ │
│  │  │     helper.setSubject("入职欢迎");                                      │ │ │
│  │  │     javaMailSender.send(msg);                                           │ │ │
│  │  └────────────────────────────────┬────────────────────────────────────────┘ │ │
│  │                                   │                                          │ │
│  │                    ┌──────────────┴──────────────┐                           │ │
│  │                    ▼                             ▼                           │ │
│  │         ┌──────────────────┐          ┌──────────────────┐                   │ │
│  │         │     发送成功     │          │     发送失败     │                   │ │
│  │         ├──────────────────┤          ├──────────────────┤                   │ │
│  │         │ redis.put(msgId) │          │ channel.basicNack│                   │ │
│  │         │ channel.basicAck │          │ (重新入队)       │                   │ │
│  │         └──────────────────┘          └──────────────────┘                   │ │
│  │                                                                               │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                     确认回调 (vhr-service)                                     │ │
│  ├───────────────────────────────────────────────────────────────────────────────┤ │
│  │                                                                               │ │
│  │  RabbitConfig.confirmCallback:                                                │ │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │  if (ack) {                                                             │ │ │
│  │  │      // 消息到达交换机                                                  │ │ │
│  │  │      UPDATE mail_send_log SET status=1 WHERE msgId=?                    │ │ │
│  │  │  } else {                                                               │ │ │
│  │  │      // 消息未到达交换机，等待定时任务重试                              │ │ │
│  │  │  }                                                                      │ │ │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │ │
│  │                                                                               │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 7. 在线聊天流程

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              WebSocket 在线聊天流程                                  │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                          1. 建立连接                                           │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │  ┌──────────────┐                                      ┌──────────────┐      │  │
│  │  │    用户A     │                                      │    用户B     │      │  │
│  │  └──────┬───────┘                                      └──────┬───────┘      │  │
│  │         │                                                     │              │  │
│  │         │ new SockJS('http://localhost:8081/ws/ep')           │              │  │
│  │         ▼                                                     ▼              │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                      WebSocketConfig                                     │ │  │
│  │  │                      端点: /ws/ep                                        │ │  │
│  │  │                      消息代理: /queue                                    │ │  │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │  │
│  │         │                                                     │              │  │
│  │         │ Stomp.over(sockjs).connect()                        │              │  │
│  │         ▼                                                     ▼              │  │
│  │  ┌──────────────────────┐                      ┌──────────────────────┐      │  │
│  │  │ 订阅: /user/queue/chat│                      │ 订阅: /user/queue/chat│      │  │
│  │  │ (实际: /user/userA/  │                      │ (实际: /user/userB/  │      │  │
│  │  │        queue/chat)   │                      │        queue/chat)   │      │  │
│  │  └──────────────────────┘                      └──────────────────────┘      │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                          2. 发送消息                                           │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │  ┌──────────────┐                                                            │  │
│  │  │    用户A     │                                                            │  │
│  │  └──────┬───────┘                                                            │  │
│  │         │                                                                    │  │
│  │         │ stomp.send('/ws/chat', {}, JSON.stringify({                        │  │
│  │         │     to: "userB",                                                   │  │
│  │         │     content: "你好!"                                               │  │
│  │         │ }))                                                                │  │
│  │         │                                                                    │  │
│  │         ▼                                                                    │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │                      WsController                                        │ │  │
│  │  │                      @MessageMapping("/ws/chat")                         │ │  │
│  │  ├─────────────────────────────────────────────────────────────────────────┤ │  │
│  │  │                                                                         │ │  │
│  │  │  public void handleMsg(Authentication auth, ChatMsg chatMsg) {          │ │  │
│  │  │                                                                         │ │  │
│  │  │      // 1. 获取发送者信息                                               │ │  │
│  │  │      Hr hr = (Hr) auth.getPrincipal();                                  │ │  │
│  │  │                                                                         │ │  │
│  │  │      // 2. 填充消息元数据                                               │ │  │
│  │  │      chatMsg.setFrom(hr.getUsername());      // userA                   │ │  │
│  │  │      chatMsg.setFromNickname(hr.getName());  // 用户A                   │ │  │
│  │  │      chatMsg.setDate(new Date());            // 时间戳                  │ │  │
│  │  │                                                                         │ │  │
│  │  │      // 3. 转发给目标用户                                               │ │  │
│  │  │      simpMessagingTemplate.convertAndSendToUser(                        │ │  │
│  │  │          chatMsg.getTo(),     // "userB"                                │ │  │
│  │  │          "/queue/chat",       // 目的地                                 │ │  │
│  │  │          chatMsg              // 消息对象                               │ │  │
│  │  │      );                                                                 │ │  │
│  │  │  }                                                                      │ │  │
│  │  │                                                                         │ │  │
│  │  └────────────────────────────────┬────────────────────────────────────────┘ │  │
│  │                                   │                                          │  │
│  │                                   │ 路由到 /user/userB/queue/chat            │  │
│  │                                   ▼                                          │  │
│  │                        ┌──────────────────────┐                              │  │
│  │                        │       用户B          │                              │  │
│  │                        │  收到消息:           │                              │  │
│  │                        │  {                   │                              │  │
│  │                        │    from: "userA",    │                              │  │
│  │                        │    fromNickname:     │                              │  │
│  │                        │      "用户A",        │                              │  │
│  │                        │    to: "userB",      │                              │  │
│  │                        │    content: "你好!", │                              │  │
│  │                        │    date: "..."       │                              │  │
│  │                        │  }                   │                              │  │
│  │                        └──────────────────────┘                              │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐  │
│  │                          3. 前端消息处理 (Vuex)                                │  │
│  ├───────────────────────────────────────────────────────────────────────────────┤  │
│  │                                                                               │  │
│  │  store/index.js:                                                              │  │
│  │  ┌─────────────────────────────────────────────────────────────────────────┐ │  │
│  │  │  actions: {                                                             │ │  │
│  │  │      connect(context) {                                                 │ │  │
│  │  │          let sock = new SockJS('/ws/ep');                               │ │  │
│  │  │          let stomp = Stomp.over(sock);                                  │ │  │
│  │  │                                                                         │ │  │
│  │  │          stomp.connect({}, () => {                                      │ │  │
│  │  │              stomp.subscribe('/user/queue/chat', (msg) => {             │ │  │
│  │  │                  let chatMsg = JSON.parse(msg.body);                    │ │  │
│  │  │                  // 显示通知                                            │ │  │
│  │  │                  Notification.info({title: chatMsg.fromNickname, ...}); │ │  │
│  │  │                  // 更新聊天记录                                        │ │  │
│  │  │                  context.commit('receiveMsg', chatMsg);                 │ │  │
│  │  │              });                                                        │ │  │
│  │  │          });                                                            │ │  │
│  │  │                                                                         │ │  │
│  │  │          context.commit('initStomp', stomp);                            │ │  │
│  │  │      }                                                                  │ │  │
│  │  │  }                                                                      │ │  │
│  │  └─────────────────────────────────────────────────────────────────────────┘ │  │
│  │                                                                               │  │
│  └───────────────────────────────────────────────────────────────────────────────┘  │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 8. 数据流转总图

```
┌─────────────────────────────────────────────────────────────────────────────────────┐
│                              VHR 系统数据流转总图                                    │
├─────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                     │
│                                    ┌─────────┐                                      │
│                                    │  用户   │                                      │
│                                    └────┬────┘                                      │
│                                         │                                           │
│           ┌─────────────────────────────┼─────────────────────────────┐             │
│           │                             │                             │             │
│           ▼                             ▼                             ▼             │
│  ┌─────────────────┐         ┌─────────────────┐         ┌─────────────────┐       │
│  │   HTTP请求      │         │   登录请求      │         │  WebSocket      │       │
│  │ (业务操作)      │         │ POST /doLogin   │         │  (实时聊天)     │       │
│  └────────┬────────┘         └────────┬────────┘         └────────┬────────┘       │
│           │                           │                           │                │
│           ▼                           ▼                           ▼                │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                         Spring Security 过滤器链                               │ │
│  │  ┌──────────────────────────────────────────────────────────────────────────┐ │ │
│  │  │                                                                          │ │ │
│  │  │  ┌──────────┐    ┌──────────────────┐    ┌─────────────────┐            │ │ │
│  │  │  │ Login    │───▶│ MetadataSource   │───▶│ DecisionManager │            │ │ │
│  │  │  │ Filter   │    │ (获取URL权限)    │    │ (权限决策)      │            │ │ │
│  │  │  └──────────┘    └──────────────────┘    └─────────────────┘            │ │ │
│  │  │       │                   │                      │                      │ │ │
│  │  │       │                   │                      │                      │ │ │
│  │  │       ▼                   ▼                      ▼                      │ │ │
│  │  │  ┌──────────┐    ┌──────────────────┐    ┌─────────────────┐            │ │ │
│  │  │  │HrService │    │  Redis缓存       │    │ 放行/拒绝       │            │ │ │
│  │  │  │认证      │    │  (菜单数据)      │    │                 │            │ │ │
│  │  │  └──────────┘    └──────────────────┘    └─────────────────┘            │ │ │
│  │  │                                                                          │ │ │
│  │  └──────────────────────────────────────────────────────────────────────────┘ │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│                                         │                                          │
│                                         ▼                                          │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Controller 层                                     │ │
│  │  ┌─────────────┬─────────────┬─────────────┬─────────────┬─────────────────┐  │ │
│  │  │EmpBasic     │SystemConfig │Salary       │Chat         │Ws               │  │ │
│  │  │Controller   │Controller   │Controller   │Controller   │Controller       │  │ │
│  │  └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────┴────────┬────────┘  │ │
│  │         │             │             │             │               │           │ │
│  └─────────┼─────────────┼─────────────┼─────────────┼───────────────┼───────────┘ │
│            │             │             │             │               │             │
│            ▼             ▼             ▼             ▼               ▼             │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Service 层                                        │ │
│  │  ┌─────────────┬─────────────┬─────────────┬─────────────────────────────────┐│ │
│  │  │Employee     │Menu         │Salary       │Hr                               ││ │
│  │  │Service      │Service      │Service      │Service                          ││ │
│  │  └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────────────────────────┘│ │
│  │         │             │             │             │                           │ │
│  └─────────┼─────────────┼─────────────┼─────────────┼───────────────────────────┘ │
│            │             │             │             │                             │
│            ▼             ▼             ▼             ▼                             │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                              Mapper 层 (MyBatis)                               │ │
│  │  ┌─────────────┬─────────────┬─────────────┬─────────────────────────────────┐│ │
│  │  │Employee     │Menu         │Salary       │Hr                               ││ │
│  │  │Mapper       │Mapper       │Mapper       │Mapper                           ││ │
│  │  └──────┬──────┴──────┬──────┴──────┬──────┴──────┬──────────────────────────┘│ │
│  │         │             │             │             │                           │ │
│  └─────────┼─────────────┼─────────────┼─────────────┼───────────────────────────┘ │
│            │             │             │             │                             │
│            └─────────────┴─────────────┴─────────────┘                             │
│                                    │                                               │
│                                    ▼                                               │
│                          ┌─────────────────┐                                       │
│                          │     MySQL       │                                       │
│                          │   (数据存储)    │                                       │
│                          └─────────────────┘                                       │
│                                                                                     │
│  ┌───────────────────────────────────────────────────────────────────────────────┐ │
│  │                           异步消息流                                           │ │
│  │                                                                               │ │
│  │   EmployeeService ──────▶ RabbitMQ ──────▶ MailReceiver ──────▶ SMTP邮件服务  │ │
│  │   (新增员工)              (消息队列)        (消费处理)          (发送邮件)    │ │
│  │                              │                  │                             │ │
│  │                              │                  ▼                             │ │
│  │                              │             ┌─────────┐                        │ │
│  │                              └────────────▶│  Redis  │ (幂等去重)             │ │
│  │                                            └─────────┘                        │ │
│  │                                                                               │ │
│  └───────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 快速索引

| 流程 | 关键组件 | 说明 |
|------|----------|------|
| 用户认证 | LoginFilter → HrService → BCrypt | JSON登录 + 验证码 |
| 权限校验 | MetadataSource → DecisionManager | 动态URL权限 |
| 动态菜单 | MenuService → Redis → Vue Router | 按角色加载菜单 |
| 员工管理 | EmployeeService → RabbitMQ | CRUD + 邮件通知 |
| 邮件发送 | RabbitMQ → MailReceiver → SMTP | 异步可靠投递 |
| 在线聊天 | WebSocket → WsController → STOMP | 点对点实时通信 |
