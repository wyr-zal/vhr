# WebSocket é…ç½®ç±»ï¼ˆWebSocketConfigï¼‰

## 1ï¸âƒ£ ç»„ä»¶å®šä½

- æ¨¡å—ä½ç½®ï¼š`vhr-web / config`
- ç±»åï¼š`WebSocketConfig`
- æŠ€æœ¯ç‚¹ï¼š
  - Spring WebSocket
  - STOMP åè®®
  - SockJS å…¼å®¹
  - æ¶ˆæ¯ä»£ç†ï¼ˆMessage Brokerï¼‰

> è¿™æ˜¯ **WebSocket çš„æ ¸å¿ƒé…ç½®ç±»**ï¼Œä¸ºåœ¨çº¿èŠå¤©åŠŸèƒ½æä¾›å®æ—¶é€šä¿¡èƒ½åŠ›ã€‚

---

## 2ï¸âƒ£ è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

### å¦‚æœæ²¡æœ‰å®ƒ
- æ— æ³•å»ºç«‹ WebSocket è¿æ¥
- å‰ç«¯æ— æ³•ä¸åç«¯å®æ—¶é€šä¿¡
- åœ¨çº¿èŠå¤©åŠŸèƒ½æ— æ³•å®ç°
- æ¶ˆæ¯æ— æ³•æ¨é€åˆ°æŒ‡å®šç”¨æˆ·

### æœ‰äº†å®ƒä¹‹å
- é…ç½® WebSocket ç«¯ç‚¹ä¾›å‰ç«¯è¿æ¥
- å¯ç”¨ STOMP åè®®ç®€åŒ–æ¶ˆæ¯å¤„ç†
- SockJS æä¾›æµè§ˆå™¨å…¼å®¹æ€§
- æ¶ˆæ¯ä»£ç†æ”¯æŒç‚¹å¯¹ç‚¹é€šä¿¡

---

## 3ï¸âƒ£ ç”Ÿæ•ˆèŒƒå›´ & æ‰§è¡Œæ—¶æœº

### ç”Ÿæ•ˆèŒƒå›´
- æ‰€æœ‰ WebSocket è¿æ¥
- åœ¨çº¿èŠå¤©æ¨¡å—

### é…ç½®åŠ è½½æ—¶æœº
```text
Spring å®¹å™¨å¯åŠ¨
        â†“
@EnableWebSocketMessageBroker å¯ç”¨ WebSocket æ¶ˆæ¯ä»£ç†
        â†“
æ³¨å†Œ STOMP ç«¯ç‚¹ /ws/ep
        â†“
é…ç½®æ¶ˆæ¯ä»£ç†å‰ç¼€ /queue
        â†“
ç­‰å¾…å®¢æˆ·ç«¯è¿æ¥
```

---

## 4ï¸âƒ£ æ ¸å¿ƒé…ç½®è§£æ

```java
@Configuration
@EnableWebSocketMessageBroker  // å¯ç”¨ WebSocket æ¶ˆæ¯ä»£ç†
public class WebSocketConfig implements WebSocketMessageBrokerConfigurer {

    /**
     * æ³¨å†Œ STOMP ç«¯ç‚¹
     * å®¢æˆ·ç«¯é€šè¿‡æ­¤ç«¯ç‚¹å»ºç«‹ WebSocket è¿æ¥
     */
    @Override
    public void registerStompEndpoints(StompEndpointRegistry registry) {
        registry.addEndpoint("/ws/ep")           // ç«¯ç‚¹è·¯å¾„
                .setAllowedOrigins("http://localhost:8080")  // å…è®¸çš„è·¨åŸŸæ¥æº
                .withSockJS();                   // å¯ç”¨ SockJS å…¼å®¹
    }

    /**
     * é…ç½®æ¶ˆæ¯ä»£ç†
     * å®šä¹‰æ¶ˆæ¯çš„ç›®çš„åœ°å‰ç¼€
     */
    @Override
    public void configureMessageBroker(MessageBrokerRegistry registry) {
        // å¯ç”¨ç®€å•æ¶ˆæ¯ä»£ç†ï¼Œå‰ç¼€ä¸º /queue
        // å®¢æˆ·ç«¯è®¢é˜… /queue/** çš„æ¶ˆæ¯ä¼šç”±æ­¤ä»£ç†å¤„ç†
        registry.enableSimpleBroker("/queue");
    }
}
```

---

## 5ï¸âƒ£ é…ç½®é¡¹è¯´æ˜

### STOMP ç«¯ç‚¹é…ç½®

| é…ç½® | è¯´æ˜ |
|------|------|
| `addEndpoint("/ws/ep")` | WebSocket è¿æ¥ç«¯ç‚¹ï¼Œå‰ç«¯é€šè¿‡æ­¤åœ°å€è¿æ¥ |
| `setAllowedOrigins(...)` | å…è®¸çš„è·¨åŸŸæ¥æºï¼ˆå‰ç«¯å¼€å‘æœåŠ¡å™¨åœ°å€ï¼‰ |
| `withSockJS()` | å¯ç”¨ SockJS æ”¯æŒï¼Œå…¼å®¹ä¸æ”¯æŒ WebSocket çš„æµè§ˆå™¨ |

### æ¶ˆæ¯ä»£ç†é…ç½®

| é…ç½® | è¯´æ˜ |
|------|------|
| `enableSimpleBroker("/queue")` | å¯ç”¨å†…å­˜æ¶ˆæ¯ä»£ç†ï¼Œå¤„ç† `/queue` å‰ç¼€çš„è®¢é˜… |

---

## 6ï¸âƒ£ WebSocket è¿æ¥æµç¨‹

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    WebSocket è¿æ¥å»ºç«‹æµç¨‹                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å‰ç«¯ (Vue)                                                 â”‚
â”‚       â†“                                                     â”‚
â”‚  new SockJS('http://localhost:8081/ws/ep')                  â”‚
â”‚       â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ SockJS å°è¯•å»ºç«‹è¿æ¥                                  â”‚   â”‚
â”‚  â”‚ 1. ä¼˜å…ˆä½¿ç”¨ WebSocket                               â”‚   â”‚
â”‚  â”‚ 2. å›é€€åˆ° xhr-streaming                             â”‚   â”‚
â”‚  â”‚ 3. å›é€€åˆ° xhr-polling                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â†“                                                     â”‚
â”‚  åç«¯ WebSocketConfig                                       â”‚
â”‚       â†“                                                     â”‚
â”‚  è¿æ¥å»ºç«‹æˆåŠŸ                                               â”‚
â”‚       â†“                                                     â”‚
â”‚  Stomp.over(sock) åˆ›å»º STOMP å®¢æˆ·ç«¯                         â”‚
â”‚       â†“                                                     â”‚
â”‚  stomp.connect() å»ºç«‹ STOMP è¿æ¥                            â”‚
â”‚       â†“                                                     â”‚
â”‚  stomp.subscribe('/user/queue/chat', callback)              â”‚
â”‚  è®¢é˜…ç”¨æˆ·ä¸“å±æ¶ˆæ¯é˜Ÿåˆ—                                        â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7ï¸âƒ£ æ¶ˆæ¯æµè½¬æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    STOMP æ¶ˆæ¯æµè½¬                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  å‘é€æ–¹ (UserA)                                             â”‚
â”‚       â†“                                                     â”‚
â”‚  stomp.send('/ws/chat', {}, JSON.stringify(chatMsg))        â”‚
â”‚       â†“                                                     â”‚
â”‚  åç«¯ WsController.handleMsg()                              â”‚
â”‚       â†“                                                     â”‚
â”‚  simpMessagingTemplate.convertAndSendToUser(                â”‚
â”‚      chatMsg.getTo(),        // ç›®æ ‡ç”¨æˆ·å                   â”‚
â”‚      "/queue/chat",          // ç›®çš„åœ°                      â”‚
â”‚      chatMsg                 // æ¶ˆæ¯å†…å®¹                     â”‚
â”‚  )                                                          â”‚
â”‚       â†“                                                     â”‚
â”‚  æ¶ˆæ¯ä»£ç†å°†æ¶ˆæ¯è·¯ç”±åˆ° /user/{username}/queue/chat           â”‚
â”‚       â†“                                                     â”‚
â”‚  æ¥æ”¶æ–¹ (UserB) è®¢é˜…çš„ /user/queue/chat æ”¶åˆ°æ¶ˆæ¯            â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8ï¸âƒ£ å…³é”®æ¦‚å¿µ

### STOMP åè®®
- **S**imple **T**ext **O**riented **M**essaging **P**rotocol
- WebSocket ä¹‹ä¸Šçš„å­åè®®ï¼Œæä¾›æ¶ˆæ¯è¯­ä¹‰
- æ”¯æŒï¼šCONNECTã€SUBSCRIBEã€SENDã€DISCONNECT ç­‰å‘½ä»¤

### SockJS
- WebSocket çš„æµè§ˆå™¨å…¼å®¹æ–¹æ¡ˆ
- è‡ªåŠ¨é™çº§åˆ° HTTP é•¿è½®è¯¢ç­‰æ–¹å¼
- ä¿è¯åœ¨å„ç§æµè§ˆå™¨ç¯å¢ƒä¸‹éƒ½èƒ½é€šä¿¡

### æ¶ˆæ¯ä»£ç†
- è´Ÿè´£æ¶ˆæ¯çš„è·¯ç”±å’Œåˆ†å‘
- æ”¯æŒå¹¿æ’­ï¼ˆtopicï¼‰å’Œç‚¹å¯¹ç‚¹ï¼ˆqueueï¼‰
- Spring å†…ç½®ç®€å•ä»£ç†ï¼Œä¹Ÿå¯é›†æˆ RabbitMQ ç­‰å¤–éƒ¨ä»£ç†

---

## 9ï¸âƒ£ å‰ç«¯ä»£ç†é…ç½®ï¼ˆvue.config.jsï¼‰

```javascript
module.exports = {
    devServer: {
        proxy: {
            // WebSocket ä»£ç†é…ç½®
            '/ws': {
                target: 'ws://localhost:8081',
                ws: true  // å¯ç”¨ WebSocket ä»£ç†
            },
            // HTTP API ä»£ç†
            '/': {
                target: 'http://localhost:8081',
                changeOrigin: true
            }
        }
    }
}
```

---

## ğŸ”Ÿ ä¸ WsController çš„å…³ç³»

WebSocketConfig æä¾›åŸºç¡€è®¾æ–½ï¼ŒWsController å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼š

```text
WebSocketConfig              WsController
      â”‚                           â”‚
      â”‚ é…ç½®ç«¯ç‚¹ /ws/ep           â”‚
      â”‚ é…ç½®ä»£ç† /queue           â”‚
      â”‚                           â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                  â”‚
                                  â”‚ @MessageMapping("/ws/chat")
                                  â”‚ å¤„ç†æ¶ˆæ¯å‘é€é€»è¾‘
                                  â”‚
                                  â”‚ simpMessagingTemplate
                                  â”‚ å‘é€æ¶ˆæ¯ç»™æŒ‡å®šç”¨æˆ·
                                  â”‚
```
