# WebSocket æ§åˆ¶å™¨ï¼ˆWsControllerï¼‰

## 1ï¸âƒ£ ç»„ä»¶å®šä½

- æ¨¡å—ä½ç½®ï¼š`vhr-web / controller`
- ç±»åï¼š`WsController`
- æŠ€æœ¯ç‚¹ï¼š
  - `@MessageMapping` æ¶ˆæ¯æ˜ å°„
  - `SimpMessagingTemplate` æ¶ˆæ¯æ¨¡æ¿
  - Spring Security é›†æˆ
  - ç‚¹å¯¹ç‚¹æ¶ˆæ¯å‘é€

> è¿™æ˜¯ **WebSocket æ¶ˆæ¯å¤„ç†æ§åˆ¶å™¨**ï¼Œè´Ÿè´£æ¥æ”¶å’Œè½¬å‘èŠå¤©æ¶ˆæ¯ã€‚

---

## 2ï¸âƒ£ è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

### å¦‚æœæ²¡æœ‰å®ƒ
- WebSocket æ¶ˆæ¯æ— äººå¤„ç†
- æ— æ³•å®ç°ç”¨æˆ·é—´çš„æ¶ˆæ¯è½¬å‘
- æ¶ˆæ¯ç¼ºå°‘å‘é€è€…ä¿¡æ¯
- æ¶ˆæ¯ç¼ºå°‘æ—¶é—´æˆ³

### æœ‰äº†å®ƒä¹‹å
- æ¥æ”¶ STOMP æ¶ˆæ¯å¹¶å¤„ç†
- è‡ªåŠ¨å¡«å……å‘é€è€…ä¿¡æ¯
- æ·»åŠ æ¶ˆæ¯æ—¶é—´æˆ³
- å°†æ¶ˆæ¯è½¬å‘ç»™ç›®æ ‡ç”¨æˆ·

---

## 3ï¸âƒ£ ç”Ÿæ•ˆèŒƒå›´ & æ‰§è¡Œæ—¶æœº

### ç”Ÿæ•ˆèŒƒå›´
- æ‰€æœ‰å‘é€åˆ° `/ws/chat` çš„ STOMP æ¶ˆæ¯

### æ‰§è¡Œæ—¶æœº
```text
å‰ç«¯å‘é€æ¶ˆæ¯
stomp.send('/ws/chat', {}, JSON.stringify(chatMsg))
            â†“
Spring WebSocket æ¥æ”¶
            â†“
WsController.handleMsg() å¤„ç†
            â†“
è½¬å‘ç»™ç›®æ ‡ç”¨æˆ·
```

---

## 4ï¸âƒ£ æ ¸å¿ƒä»£ç è§£æ

```java
@Controller
public class WsController {

    // æ¶ˆæ¯å‘é€æ¨¡æ¿ï¼šç”¨äºå‘æŒ‡å®šç”¨æˆ·å‘é€æ¶ˆæ¯
    @Autowired
    SimpMessagingTemplate simpMessagingTemplate;

    /**
     * å¤„ç†èŠå¤©æ¶ˆæ¯
     * @param authentication Spring Security è®¤è¯ä¿¡æ¯ï¼ˆè‡ªåŠ¨æ³¨å…¥ï¼‰
     * @param chatMsg å‰ç«¯å‘é€çš„èŠå¤©æ¶ˆæ¯å¯¹è±¡
     */
    @MessageMapping("/ws/chat")  // æ˜ å°„ STOMP æ¶ˆæ¯ç›®çš„åœ°
    public void handleMsg(Authentication authentication, ChatMsg chatMsg) {
        // 1. ä»è®¤è¯ä¿¡æ¯ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·
        Hr hr = (Hr) authentication.getPrincipal();

        // 2. å¡«å……æ¶ˆæ¯çš„å‘é€è€…ä¿¡æ¯
        chatMsg.setFrom(hr.getUsername());      // å‘é€è€…ç”¨æˆ·å
        chatMsg.setFromNickname(hr.getName());  // å‘é€è€…æ˜µç§°

        // 3. è®¾ç½®æ¶ˆæ¯æ—¶é—´æˆ³
        chatMsg.setDate(new Date());

        // 4. å°†æ¶ˆæ¯å‘é€ç»™ç›®æ ‡ç”¨æˆ·
        simpMessagingTemplate.convertAndSendToUser(
            chatMsg.getTo(),        // ç›®æ ‡ç”¨æˆ·å
            "/queue/chat",          // ç›®çš„åœ°ï¼ˆç”¨æˆ·ä¼šè®¢é˜… /user/queue/chatï¼‰
            chatMsg                 // æ¶ˆæ¯å†…å®¹
        );
    }
}
```

---

## 5ï¸âƒ£ æ¶ˆæ¯å¤„ç†æµç¨‹å›¾

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¶ˆæ¯å¤„ç†å®Œæ•´æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  ç”¨æˆ·A (å‘é€æ–¹)                                              â”‚
â”‚       â†“                                                     â”‚
â”‚  æ„å»ºæ¶ˆæ¯å¯¹è±¡:                                               â”‚
â”‚  {                                                          â”‚
â”‚      to: "userB",        // ç›®æ ‡ç”¨æˆ·                        â”‚
â”‚      content: "ä½ å¥½!"     // æ¶ˆæ¯å†…å®¹                        â”‚
â”‚  }                                                          â”‚
â”‚       â†“                                                     â”‚
â”‚  stomp.send('/ws/chat', {}, JSON.stringify(chatMsg))        â”‚
â”‚       â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ WsController.handleMsg()                            â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ 1. è·å–å‘é€è€…ä¿¡æ¯ (ä» Security Context)             â”‚   â”‚
â”‚  â”‚    hr = authentication.getPrincipal()               â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ 2. å¡«å……æ¶ˆæ¯                                         â”‚   â”‚
â”‚  â”‚    chatMsg.from = "userA"                           â”‚   â”‚
â”‚  â”‚    chatMsg.fromNickname = "ç”¨æˆ·A"                   â”‚   â”‚
â”‚  â”‚    chatMsg.date = new Date()                        â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚ 3. è½¬å‘æ¶ˆæ¯                                         â”‚   â”‚
â”‚  â”‚    simpMessagingTemplate.convertAndSendToUser(...)  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚       â†“                                                     â”‚
â”‚  ç”¨æˆ·B è®¢é˜…çš„ /user/queue/chat æ”¶åˆ°æ¶ˆæ¯:                     â”‚
â”‚  {                                                          â”‚
â”‚      from: "userA",                                         â”‚
â”‚      fromNickname: "ç”¨æˆ·A",                                 â”‚
â”‚      to: "userB",                                           â”‚
â”‚      content: "ä½ å¥½!",                                       â”‚
â”‚      date: "2024-01-01T12:00:00"                            â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6ï¸âƒ£ ChatMsg æ¶ˆæ¯å®ä½“

```java
public class ChatMsg {
    private String from;          // å‘é€è€…ç”¨æˆ·å
    private String fromNickname;  // å‘é€è€…æ˜µç§°
    private String to;            // æ¥æ”¶è€…ç”¨æˆ·å
    private String content;       // æ¶ˆæ¯å†…å®¹
    private Date date;            // å‘é€æ—¶é—´

    // getter/setter...
}
```

---

## 7ï¸âƒ£ SimpMessagingTemplate æ–¹æ³•è¯´æ˜

### convertAndSendToUser

```java
simpMessagingTemplate.convertAndSendToUser(
    "userB",           // ç›®æ ‡ç”¨æˆ·å
    "/queue/chat",     // ç›®çš„åœ°
    chatMsg            // æ¶ˆæ¯å¯¹è±¡
);
```

**å®é™…è·¯ç”±**ï¼šæ¶ˆæ¯ä¼šå‘é€åˆ° `/user/userB/queue/chat`

**å·¥ä½œåŸç†**ï¼š
1. Spring è‡ªåŠ¨ä¸ºæ¯ä¸ªç”¨æˆ·åˆ›å»ºä¸“å±é˜Ÿåˆ—
2. ç”¨æˆ·è®¢é˜… `/user/queue/chat` æ—¶ï¼Œå®é™…è®¢é˜…çš„æ˜¯ `/user/{username}/queue/chat`
3. `convertAndSendToUser` è‡ªåŠ¨æ‹¼æ¥ç”¨æˆ·å‰ç¼€

### convertAndSendï¼ˆå¹¿æ’­ï¼‰

```java
// å¹¿æ’­ç»™æ‰€æœ‰è®¢é˜…è€…
simpMessagingTemplate.convertAndSend("/topic/notice", message);
```

---

## 8ï¸âƒ£ Spring Security é›†æˆ

### è®¤è¯ä¿¡æ¯è‡ªåŠ¨æ³¨å…¥

```java
@MessageMapping("/ws/chat")
public void handleMsg(Authentication authentication, ChatMsg chatMsg) {
    // authentication è‡ªåŠ¨æ³¨å…¥å½“å‰ç™»å½•ç”¨æˆ·çš„è®¤è¯ä¿¡æ¯
    Hr hr = (Hr) authentication.getPrincipal();
}
```

**åŸç†**ï¼š
- WebSocket è¿æ¥å»ºç«‹æ—¶ï¼Œç»§æ‰¿ HTTP ä¼šè¯çš„è®¤è¯çŠ¶æ€
- Spring Security å°†è®¤è¯ä¿¡æ¯ç»‘å®šåˆ° WebSocket ä¼šè¯
- `@MessageMapping` æ–¹æ³•å¯ä»¥ç›´æ¥æ³¨å…¥ `Authentication`

---

## 9ï¸âƒ£ å‰ç«¯æ¶ˆæ¯å¤„ç†ï¼ˆVuexï¼‰

```javascript
// store/index.js
actions: {
    connect(context) {
        // å»ºç«‹ WebSocket è¿æ¥
        let sock = new SockJS('http://localhost:8081/ws/ep');
        let stomp = Stomp.over(sock);

        stomp.connect({}, () => {
            // è®¢é˜…ç”¨æˆ·æ¶ˆæ¯
            stomp.subscribe('/user/queue/chat', (msg) => {
                let chatMsg = JSON.parse(msg.body);
                // å¤„ç†æ”¶åˆ°çš„æ¶ˆæ¯ï¼ˆæ˜¾ç¤ºé€šçŸ¥ã€æ›´æ–°æ¶ˆæ¯åˆ—è¡¨ç­‰ï¼‰
                context.commit('receiveMsg', chatMsg);
            });
        });

        // ä¿å­˜ stomp è¿æ¥åˆ° state
        context.commit('initStomp', stomp);
    },

    sendMsg(context, chatMsg) {
        // å‘é€æ¶ˆæ¯
        context.state.stomp.send(
            '/ws/chat',
            {},
            JSON.stringify(chatMsg)
        );
    }
}
```

---

## ğŸ”Ÿ å®Œæ•´èŠå¤©æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åœ¨çº¿èŠå¤©å®Œæ•´æ¶æ„                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚   ç”¨æˆ·A      â”‚              â”‚   ç”¨æˆ·B      â”‚            â”‚
â”‚  â”‚   (å‰ç«¯)     â”‚              â”‚   (å‰ç«¯)     â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚         â”‚                              â”‚                    â”‚
â”‚         â”‚ SockJS + STOMP               â”‚ SockJS + STOMP    â”‚
â”‚         â”‚                              â”‚                    â”‚
â”‚         â†“                              â†“                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 WebSocketConfig                     â”‚   â”‚
â”‚  â”‚               ç«¯ç‚¹: /ws/ep                          â”‚   â”‚
â”‚  â”‚               ä»£ç†: /queue                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                  WsController                       â”‚   â”‚
â”‚  â”‚            @MessageMapping("/ws/chat")              â”‚   â”‚
â”‚  â”‚                                                     â”‚   â”‚
â”‚  â”‚  1. æ¥æ”¶æ¶ˆæ¯                                        â”‚   â”‚
â”‚  â”‚  2. å¡«å……å‘é€è€…ä¿¡æ¯                                  â”‚   â”‚
â”‚  â”‚  3. æ·»åŠ æ—¶é—´æˆ³                                      â”‚   â”‚
â”‚  â”‚  4. è½¬å‘ç»™ç›®æ ‡ç”¨æˆ·                                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                   â”‚
â”‚                         â†“                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚            SimpMessagingTemplate                    â”‚   â”‚
â”‚  â”‚       convertAndSendToUser(to, dest, msg)           â”‚   â”‚
â”‚  â”‚              â†’ /user/{to}/queue/chat                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1ï¸âƒ£1ï¸âƒ£ æ³¨è§£è¯´æ˜

| æ³¨è§£ | è¯´æ˜ |
|------|------|
| `@Controller` | æ ‡è®°ä¸ºæ§åˆ¶å™¨ï¼ˆWebSocket ä¹Ÿä½¿ç”¨æ­¤æ³¨è§£ï¼‰ |
| `@MessageMapping` | æ˜ å°„ STOMP æ¶ˆæ¯ç›®çš„åœ°ï¼Œç±»ä¼¼ `@RequestMapping` |

### @MessageMapping vs @RequestMapping

| ç‰¹æ€§ | @MessageMapping | @RequestMapping |
|------|-----------------|-----------------|
| åè®® | WebSocket (STOMP) | HTTP |
| è¯·æ±‚æ–¹å¼ | STOMP SEND å‘½ä»¤ | GET/POST/PUT/DELETE |
| è¿”å›å€¼ | å¯é€‰ï¼ˆç›´æ¥å‘é€æˆ–é€šè¿‡æ¨¡æ¿ï¼‰ | HTTP å“åº” |
| é€‚ç”¨åœºæ™¯ | å®æ—¶é€šä¿¡ | REST API |
