# RabbitMQ é…ç½®ç±»ï¼ˆRabbitConfigï¼‰

## 1ï¸âƒ£ ç»„ä»¶å®šä½

- æ¨¡å—ä½ç½®ï¼š`vhr-service / config`
- ç±»åï¼š`RabbitConfig`
- æŠ€æœ¯ç‚¹ï¼š
  - RabbitMQ é˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šé…ç½®
  - æ¶ˆæ¯ç¡®è®¤å›è°ƒï¼ˆConfirmCallbackï¼‰
  - æ¶ˆæ¯è¿”å›å›è°ƒï¼ˆReturnCallbackï¼‰
  - æ¶ˆæ¯å¯é æ€§æŠ•é€’

> è¿™æ˜¯ **RabbitMQ çš„æ ¸å¿ƒé…ç½®ç±»**ï¼Œå®šä¹‰æ¶ˆæ¯é˜Ÿåˆ—ç»„ä»¶å¹¶é…ç½®æ¶ˆæ¯æŠ•é€’çš„å¯é æ€§ä¿éšœæœºåˆ¶ã€‚

---

## 2ï¸âƒ£ è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Ÿ

### å¦‚æœæ²¡æœ‰å®ƒ
- æ— æ³•å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢æœºå’Œç»‘å®šå…³ç³»
- æ¶ˆæ¯å‘é€åæ— æ³•ç¡®è®¤æ˜¯å¦æˆåŠŸæŠ•é€’
- æ¶ˆæ¯ä¸¢å¤±æ— æ³•æ„ŸçŸ¥
- æ— æ³•å®ç°æ¶ˆæ¯é‡è¯•æœºåˆ¶

### æœ‰äº†å®ƒä¹‹å
- è‡ªåŠ¨åˆ›å»º MQ ç»„ä»¶ï¼ˆé˜Ÿåˆ—ã€äº¤æ¢æœºã€ç»‘å®šï¼‰
- æ¶ˆæ¯æŠ•é€’ç¡®è®¤ï¼ŒæˆåŠŸ/å¤±è´¥å¯æ„ŸçŸ¥
- é…åˆæ—¥å¿—è¡¨å®ç°æ¶ˆæ¯é‡è¯•
- å®Œæ•´çš„æ¶ˆæ¯å¯é æ€§ä¿éšœ

---

## 3ï¸âƒ£ ç”Ÿæ•ˆèŒƒå›´ & æ‰§è¡Œæ—¶æœº

### ç”Ÿæ•ˆèŒƒå›´
- vhr-service æ¨¡å—ä¸­æ‰€æœ‰ä½¿ç”¨ RabbitTemplate å‘é€æ¶ˆæ¯çš„åœºæ™¯

### ç»„ä»¶åˆå§‹åŒ–æ—¶æœº
```text
Spring å®¹å™¨å¯åŠ¨
        â†“
@Configuration åŠ è½½ RabbitConfig
        â†“
æ³¨å†Œ Queueã€Exchangeã€Binding Bean
        â†“
RabbitMQ è‡ªåŠ¨åˆ›å»ºå¯¹åº”ç»„ä»¶ï¼ˆè‹¥ä¸å­˜åœ¨ï¼‰
        â†“
æ³¨å†Œ RabbitTemplate Beanï¼ˆå«å›è°ƒï¼‰
```

---

## 4ï¸âƒ£ æ ¸å¿ƒé…ç½®è§£æ

### 4.1 RabbitTemplate é…ç½®ï¼ˆå«å›è°ƒï¼‰

```java
@Bean
RabbitTemplate rabbitTemplate() {
    RabbitTemplate rabbitTemplate = new RabbitTemplate(cachingConnectionFactory);

    // æ¶ˆæ¯ç¡®è®¤å›è°ƒï¼šæ¶ˆæ¯åˆ°è¾¾äº¤æ¢æœºåè§¦å‘
    rabbitTemplate.setConfirmCallback((data, ack, cause) -> {
        String msgId = data.getId();  // è·å–æ¶ˆæ¯å”¯ä¸€ID
        if (ack) {
            logger.info(msgId + ":æ¶ˆæ¯å‘é€æˆåŠŸ");
            // æ›´æ–°æ•°æ®åº“æ—¥å¿—çŠ¶æ€ä¸ºå·²æŠ•é€’
            mailSendLogService.updateMailSendLogStatus(msgId, 1);
        } else {
            logger.info(msgId + ":æ¶ˆæ¯å‘é€å¤±è´¥");
            // çŠ¶æ€ä¿æŒ0ï¼ˆæŠ•é€’ä¸­ï¼‰ï¼Œç­‰å¾…å®šæ—¶ä»»åŠ¡é‡è¯•
        }
    });

    // æ¶ˆæ¯è¿”å›å›è°ƒï¼šæ¶ˆæ¯æ— æ³•è·¯ç”±åˆ°é˜Ÿåˆ—æ—¶è§¦å‘
    rabbitTemplate.setReturnCallback((msg, repCode, repText, exchange, routingkey) -> {
        logger.info("æ¶ˆæ¯å‘é€å¤±è´¥");
        // å¯åœ¨æ­¤è®°å½•å¤±è´¥è¯¦æƒ…ï¼Œç”¨äºæ’æŸ¥
    });

    return rabbitTemplate;
}
```

### 4.2 é˜Ÿåˆ—å®šä¹‰

```java
@Bean
Queue mailQueue() {
    // å‚æ•°ï¼šé˜Ÿåˆ—åç§°, æ˜¯å¦æŒä¹…åŒ–
    return new Queue(MailConstants.MAIL_QUEUE_NAME, true);
}
```

- **é˜Ÿåˆ—åç§°**ï¼š`javaboy.mail.queue`
- **æŒä¹…åŒ–**ï¼š`true`ï¼ˆRabbitMQ é‡å¯åé˜Ÿåˆ—ä¸ä¸¢å¤±ï¼‰

### 4.3 äº¤æ¢æœºå®šä¹‰

```java
@Bean
DirectExchange mailExchange() {
    // å‚æ•°ï¼šäº¤æ¢æœºåç§°, æ˜¯å¦æŒä¹…åŒ–, æ˜¯å¦è‡ªåŠ¨åˆ é™¤
    return new DirectExchange(MailConstants.MAIL_EXCHANGE_NAME, true, false);
}
```

- **äº¤æ¢æœºç±»å‹**ï¼šDirectï¼ˆç²¾ç¡®åŒ¹é…è·¯ç”±é”®ï¼‰
- **äº¤æ¢æœºåç§°**ï¼š`javaboy.mail.exchange`
- **æŒä¹…åŒ–**ï¼š`true`
- **è‡ªåŠ¨åˆ é™¤**ï¼š`false`

### 4.4 ç»‘å®šå…³ç³»

```java
@Bean
Binding mailBinding() {
    return BindingBuilder
            .bind(mailQueue())           // ç»‘å®šé˜Ÿåˆ—
            .to(mailExchange())          // åˆ°äº¤æ¢æœº
            .with(MailConstants.MAIL_ROUTING_KEY_NAME);  // è·¯ç”±é”®
}
```

- **è·¯ç”±é”®**ï¼š`javaboy.mail.routing.key`

---

## 5ï¸âƒ£ æ¶ˆæ¯æµè½¬æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RabbitMQ æ¶ˆæ¯æµè½¬                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Producer (vhr-service)                                     â”‚
â”‚       â†“                                                     â”‚
â”‚  rabbitTemplate.convertAndSend(                             â”‚
â”‚      "javaboy.mail.exchange",      â† Exchange               â”‚
â”‚      "javaboy.mail.routing.key",   â† RoutingKey             â”‚
â”‚      employee,                      â† æ¶ˆæ¯ä½“                 â”‚
â”‚      new CorrelationData(msgId)     â† å…³è”æ•°æ®              â”‚
â”‚  )                                                          â”‚
â”‚       â†“                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚        Direct Exchange                      â”‚           â”‚
â”‚  â”‚        (javaboy.mail.exchange)              â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                    â”‚ routing_key = "javaboy.mail.routing.key"
â”‚                    â†“                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚             Queue                           â”‚           â”‚
â”‚  â”‚        (javaboy.mail.queue)                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                    â†“                                        â”‚
â”‚  Consumer (mailserver - MailReceiver)                       â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6ï¸âƒ£ ç¡®è®¤å›è°ƒæœºåˆ¶

### ConfirmCallbackï¼ˆç¡®è®¤å›è°ƒï¼‰

```text
è§¦å‘æ¡ä»¶ï¼šæ¶ˆæ¯åˆ°è¾¾äº¤æ¢æœºåï¼ˆæ— è®ºæ˜¯å¦è·¯ç”±æˆåŠŸï¼‰

å›è°ƒå‚æ•°ï¼š
  - data: CorrelationDataï¼ˆåŒ…å«æ¶ˆæ¯IDï¼‰
  - ack: booleanï¼ˆtrue=åˆ°è¾¾äº¤æ¢æœºï¼Œfalse=æœªåˆ°è¾¾ï¼‰
  - cause: Stringï¼ˆå¤±è´¥åŸå› ï¼‰

ä½¿ç”¨åœºæ™¯ï¼š
  - ack=true â†’ æ›´æ–°æ—¥å¿—çŠ¶æ€ä¸º"å·²æŠ•é€’"
  - ack=false â†’ è®°å½•å¤±è´¥ï¼Œç­‰å¾…é‡è¯•
```

### ReturnCallbackï¼ˆè¿”å›å›è°ƒï¼‰

```text
è§¦å‘æ¡ä»¶ï¼šæ¶ˆæ¯åˆ°è¾¾äº¤æ¢æœºä½†æ— æ³•è·¯ç”±åˆ°é˜Ÿåˆ—

å›è°ƒå‚æ•°ï¼š
  - msg: æ¶ˆæ¯å†…å®¹
  - repCode: å“åº”ç 
  - repText: å“åº”æ–‡æœ¬
  - exchange: äº¤æ¢æœºå
  - routingkey: è·¯ç”±é”®

ä½¿ç”¨åœºæ™¯ï¼š
  - è·¯ç”±é”®é…ç½®é”™è¯¯
  - é˜Ÿåˆ—ä¸å­˜åœ¨
  - ç»‘å®šå…³ç³»é”™è¯¯
```

---

## 7ï¸âƒ£ æ¶ˆæ¯å¯é æ€§ä¿éšœæœºåˆ¶

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´çš„æ¶ˆæ¯å¯é æ€§ä¿éšœ                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å‘é€å‰ï¼šè®°å½•å‘é€æ—¥å¿—ï¼ˆçŠ¶æ€=æŠ•é€’ä¸­ï¼‰                      â”‚
â”‚     INSERT INTO mail_send_log (msgId, status=0, ...)        â”‚
â”‚                       â†“                                     â”‚
â”‚  2. å‘é€æ¶ˆæ¯åˆ° MQ                                           â”‚
â”‚     rabbitTemplate.convertAndSend(...)                      â”‚
â”‚                       â†“                                     â”‚
â”‚  3. ConfirmCallback ç¡®è®¤                                    â”‚
â”‚     - æˆåŠŸ: UPDATE mail_send_log SET status=1               â”‚
â”‚     - å¤±è´¥: çŠ¶æ€ä¿æŒ0                                        â”‚
â”‚                       â†“                                     â”‚
â”‚  4. å®šæ—¶ä»»åŠ¡æ‰«æï¼ˆå¯é€‰ï¼‰                                     â”‚
â”‚     - æŸ¥è¯¢ status=0 ä¸” è¶…æ—¶çš„è®°å½•                            â”‚
â”‚     - é‡æ–°å‘é€æ¶ˆæ¯                                           â”‚
â”‚     - è¶…è¿‡é‡è¯•æ¬¡æ•°åˆ™æ ‡è®°ä¸ºå¤±è´¥                               â”‚
â”‚                       â†“                                     â”‚
â”‚  5. æ¶ˆè´¹ç«¯å¤„ç†                                               â”‚
â”‚     - Redis å»é‡                                             â”‚
â”‚     - æ‰‹åŠ¨ ACK                                               â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8ï¸âƒ£ é…ç½®ä¾èµ–ï¼ˆapplication.ymlï¼‰

```yaml
spring:
  rabbitmq:
    host: 192.168.100.128
    port: 5672
    username: guest
    password: guest
    # å¼€å¯å‘å¸ƒç¡®è®¤
    publisher-confirm-type: correlated
    # å¼€å¯å‘å¸ƒè¿”å›
    publisher-returns: true
```

| é…ç½®é¡¹ | è¯´æ˜ |
|--------|------|
| `publisher-confirm-type: correlated` | å¼€å¯ç¡®è®¤å›è°ƒï¼Œä½¿ç”¨ CorrelationData å…³è” |
| `publisher-returns: true` | å¼€å¯è¿”å›å›è°ƒ |

---

## 9ï¸âƒ£ å¸¸é‡å®šä¹‰

```java
public class MailConstants {
    // é˜Ÿåˆ—åç§°
    public static final String MAIL_QUEUE_NAME = "javaboy.mail.queue";
    // äº¤æ¢æœºåç§°
    public static final String MAIL_EXCHANGE_NAME = "javaboy.mail.exchange";
    // è·¯ç”±é”®
    public static final String MAIL_ROUTING_KEY_NAME = "javaboy.mail.routing.key";

    // æŠ•é€’çŠ¶æ€
    public static final Integer DELIVERING = 0;  // æŠ•é€’ä¸­
    public static final Integer SUCCESS = 1;     // æˆåŠŸ
    public static final Integer FAILURE = 2;     // å¤±è´¥
}
```

---

## ğŸ”Ÿ ä¸å…¶ä»–ç»„ä»¶çš„å…³ç³»

```text
                    RabbitConfig
                         â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“               â†“               â†“
    RabbitTemplate   Queue/Exchange   MailSendLogService
         â”‚                               â”‚
         â†“                               â†“
    EmployeeService.addEmp()        è®°å½•/æ›´æ–°æ—¥å¿—
         â”‚
         â†“
    mailserver.MailReceiver (æ¶ˆè´¹)
```
